<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl">
  
  
  
  
  <title>mysql优化 | 小代blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="MySQL优化步（InnoDB）优化的优先级- 数据库结构设计 - SQL语句 - 数据库存储引擎和选择和参数配置 - 系统选择及优化 - 硬件升级 图书 MySQL必知必会  - 高性能MySQL - 深入浅出MySQL - MySQL排错指南 - MySQL管理之道-性能高估、高可用和监控（第一版） - MySQL管理之道-性能高估、高可用和监控（第二版） - MySQL技术内幕 -– 安装向">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql优化">
<meta property="og:url" content="http://yoursite.com/2018/09/30/mysql/index.html">
<meta property="og:site_name" content="小代blog">
<meta property="og:description" content="MySQL优化步（InnoDB）优化的优先级- 数据库结构设计 - SQL语句 - 数据库存储引擎和选择和参数配置 - 系统选择及优化 - 硬件升级 图书 MySQL必知必会  - 高性能MySQL - 深入浅出MySQL - MySQL排错指南 - MySQL管理之道-性能高估、高可用和监控（第一版） - MySQL管理之道-性能高估、高可用和监控（第二版） - MySQL技术内幕 -– 安装向">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-11-05T05:46:37.897Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mysql优化">
<meta name="twitter:description" content="MySQL优化步（InnoDB）优化的优先级- 数据库结构设计 - SQL语句 - 数据库存储引擎和选择和参数配置 - 系统选择及优化 - 硬件升级 图书 MySQL必知必会  - 高性能MySQL - 深入浅出MySQL - MySQL排错指南 - MySQL管理之道-性能高估、高可用和监控（第一版） - MySQL管理之道-性能高估、高可用和监控（第二版） - MySQL技术内幕 -– 安装向">
  
    <link rel="alternative" href="/atom.xml" title="小代blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

        <a href="/" class="profilepic">
            
            <img lazy-src="/img/timg.jpg" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">代晓炜</a></h1>
        </hgroup>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/categories/开发工具/">玩转开发工具</a></li>
                        
                            <li><a href="/categories/digital">玩转数码</a></li>
                        
                            <li><a href="/categories/algorithm">算法学习</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/weixiaodai1/" title="github">github</a>
                            
                                <a class="fl weibo" target="_blank" href="https://weibo.com/u/2791048663" title="weibo">weibo</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/VUE/" style="font-size: 10px;">VUE</a> <a href="/tags/cordova-命令/" style="font-size: 10px;">cordova 命令</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/命令/" style="font-size: 10px;">命令</a> <a href="/tags/语法/" style="font-size: 10px;">语法</a> <a href="/tags/配置/" style="font-size: 10px;">配置</a>
                    </div>
                </section>
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://blog.csdn.net/daixiaowei123">csdn</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://segmentfault.com/blog/maocg_web">segmentfault</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/users/eb37ef89c746/latest_articles">简书</a>
                    
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">爱动漫,爱游戏,爱编程,爱运动,爱的太多了!</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">代晓炜</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/timg.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">代晓炜</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/categories/开发工具/">玩转开发工具</a></li>
                
                    <li><a href="/categories/digital">玩转数码</a></li>
                
                    <li><a href="/categories/algorithm">算法学习</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/weixiaodai1/" title="github">github</a>
                    
                        <a class="weibo" target="_blank" href="https://weibo.com/u/2791048663" title="weibo">weibo</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>
    </div>
</nav>
      <div class="body-wrap"><article id="post-mysql" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/09/30/mysql/" class="article-date">
      <time datetime="2018-09-30T05:40:12.000Z" itemprop="datePublished">2018-09-30</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      mysql优化
    </h1>
  


      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/数据库/">数据库</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="MySQL优化步（InnoDB）"><a href="#MySQL优化步（InnoDB）" class="headerlink" title="MySQL优化步（InnoDB）"></a>MySQL优化步（InnoDB）</h1><h2 id="优化的优先级"><a href="#优化的优先级" class="headerlink" title="优化的优先级"></a>优化的优先级</h2><p>- 数据库结构设计</p>
<p>- SQL语句</p>
<p>- 数据库存储引擎和选择和参数配置</p>
<p>- 系统选择及优化</p>
<p>- 硬件升级</p>
<h2 id="图书"><a href="#图书" class="headerlink" title="图书"></a>图书</h2><ul>
<li>MySQL必知必会</li>
</ul>
<p>- 高性能MySQL</p>
<p>- 深入浅出MySQL</p>
<p>- MySQL排错指南</p>
<p>- MySQL管理之道-性能高估、高可用和监控（第一版）</p>
<p>- MySQL管理之道-性能高估、高可用和监控（第二版）</p>
<p>- MySQL技术内幕</p>
<p>-–</p>
<h2 id="安装向导中的选项"><a href="#安装向导中的选项" class="headerlink" title="安装向导中的选项"></a>安装向导中的选项</h2><p>安装过程中的选择</p>
<p>-–</p>
<h2 id="调试方法"><a href="#调试方法" class="headerlink" title="调试方法"></a>调试方法</h2><p>- show status：提供服务器状态信息</p>
<p>- show engine innodb status 查看innodb引擎的服务器状况</p>
<p>- show variables</p>
<p>- EXPLAIN</p>
<p>- show profile</p>
<p>- performance_schema</p>
<p>- show processlist</p>
<p>- sql_no_cache</p>
<p>- slow_query_log</p>
<h3 id="show-status"><a href="#show-status" class="headerlink" title="show status"></a>show status</h3><p>show [session|global] status</p>
<p>\<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">\-</span> session: 当前连接，默认为session</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> global: 自数据库上次启动至今</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 常用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> Connections: 试图连接MySQL服务器的次数</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> Uptime:服务器工作时间</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> Slow_queries:慢查询的次数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\</span></span><br></pre></td></tr></table></figure></p>
<p>show status like ‘Com_%’ /<em>表示语句执行次数</em>/</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### show variables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### EXPLAIN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>mysql&gt; explain select * from table_name;</p>
<p>+—-+————-+————+——+—————+——+———+——+——+——-+</p>
<p>| id | select_type | table      | type | possible_keys | key  | key_len | ref  | rows | Extra |</p>
<p>+—-+————-+————+——+—————+——+———+——+——+——-+</p>
<p>|  1 | SIMPLE      | table_name | ALL  | NULL          | NULL | NULL    | NULL |    1 | NULL  |</p>
<p>+—-+————-+————+——+—————+——+———+——+——+——-+</p>
<p>1 row in set (0.00 sec)</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">| 字段           | 说明|</span><br><span class="line"></span><br><span class="line">| :------        |:------|</span><br><span class="line"></span><br><span class="line">| id             |表示查询中执行select子句或操作表的顺序 |</span><br><span class="line"></span><br><span class="line">| select_type    |查询中每个select子句的类型 |</span><br><span class="line"></span><br><span class="line">| table          |输出结果集的表| </span><br><span class="line"></span><br><span class="line">| type           |表示MySQL在表中找到的所需行的方式，或者叫访问类型|</span><br><span class="line"></span><br><span class="line">| possible_keys  |表示查询时可能使用的索引|</span><br><span class="line"></span><br><span class="line">| key            |表示实际使用的索引，若没有使用索引，显示为NULL|</span><br><span class="line"></span><br><span class="line">| key_len        |使用到索引字段的字节数（长度）|</span><br><span class="line"></span><br><span class="line">| ref            |表示上述表的连接匹配条件，即哪些列或常量被用于查找索引列上的值|</span><br><span class="line"></span><br><span class="line">| rows           |扫描行的数量  |</span><br><span class="line"></span><br><span class="line">| Extra          |包含不适合在其他列中显示但十分重要的额外信息|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\##### id</span><br><span class="line"></span><br><span class="line">\1. id相同，执行顺序由上至下</span><br><span class="line"></span><br><span class="line">\1. 如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</span><br><span class="line"></span><br><span class="line">\1. id如果相同，可以认为是一组，从上往下顺序执行；在所有组中，id值越大，优先级越高，越先执行</span><br><span class="line"></span><br><span class="line">\##### select_type</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">| 字段                  | 说明|</span><br><span class="line"></span><br><span class="line">| :------              |:------|</span><br><span class="line"></span><br><span class="line">| SIMPLE               |简单的SELECT语句（没有使用 union 或者 子查询） |</span><br><span class="line"></span><br><span class="line">| PRIMARY              |查询中若包含任何复杂的子部分,最外层的select被标记为PRIMARY |</span><br><span class="line"></span><br><span class="line">| UNION                |在一个UNION语句中第二或之后的SELECT语句| </span><br><span class="line"></span><br><span class="line">| DEPENDENT UNION      |在一个UNION语句中第二或之后的SELECT语句，取决于外层的查询|</span><br><span class="line"></span><br><span class="line">| UNION RESULT         |UNION的结果集|</span><br><span class="line"></span><br><span class="line">| SUBQUERY             |子查询中的第一个SELECT|</span><br><span class="line"></span><br><span class="line">| DEPENDENT SUBQUERY   |子查询中的第一个SELECT，取决于外面的查询|</span><br><span class="line"></span><br><span class="line">| DERIVED              |派生表的SELECT, FROM子句的子查询|</span><br><span class="line"></span><br><span class="line">| UNCACHEABLE SUBQUERY |不能将结果缓存的子查询，必须重新计算外部查询的每一行|</span><br><span class="line"></span><br><span class="line">| UNCACHEABLE UNION    |在一个UNION中第二或之后的SELECT查询属于UNCACHEABLE SUBQUERY（请看UNCACHEABLE SUBQUERY)|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line"></span><br><span class="line">\- DEPENDENT：典型代表就是使用了相关子查询。（相关子查询：子查询里包含了一个同时在子查询里，又在外部查询的表的查询）</span><br><span class="line"></span><br><span class="line">\- DEPENDENT SUBQUERY: 它不同于UNCACHEABLE SUBQUERY的求值。对于DEPENDENT SUBQUERY，子查询对于外部上下文里每一个集合中不同的变星值仅仅重新计算一次。而对于UNCACHEABLE SUBQUERY，子查询对于外部上下文里的每一行都会重新计算一次.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\##### type</span><br><span class="line"></span><br><span class="line">常用的类型有（从左到右，性能从差到好）：</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>+—–+——-+——-+——+——–+—————-+——+</p>
<p>| ALL | index | range | ref  | eq_ref | const, system  | NULL |</p>
<p>+—–+——-+——-+——+——–+—————-+——+</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">| 字段          | 说明|</span><br><span class="line"></span><br><span class="line">| :------       |:------|</span><br><span class="line"></span><br><span class="line">| ALL           |全表扫描，MySQL遍历全表来找到匹配的行 |</span><br><span class="line"></span><br><span class="line">| index         |索引全扫描，MySQL遍历整个索引来查询匹配的行，index与ALL区别为index类型只遍历索引树。 |</span><br><span class="line"></span><br><span class="line">| range         |索引范围扫描，只检索给定范围的行，使用一个索引来选择行，常见于`&lt;、&lt;=、&gt;、&gt;=、between`等操作符。| </span><br><span class="line"></span><br><span class="line">| ref           |使用非唯一索引扫描或唯一索引的前缀扫描，返回匹配某个单独值的记录行|</span><br><span class="line"></span><br><span class="line">| eq_ref        |类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件|</span><br><span class="line"></span><br><span class="line">| const, system |当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。如将主键置于where列表中，MySQL就能将该查询转换为一个常量|</span><br><span class="line"></span><br><span class="line">| NULL          |MySQL在优化过程中分解语句，执行时甚至不用访问表或索引，例如从一个索引列里选取最小值可以通过单独索引查找完成。|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\##### explain extended和show warnings</span><br><span class="line"></span><br><span class="line">explain 的extended 扩展能够在原本explain的基础上额外的提供一些查询优化的信息，这些信息可以通过MySQL的show warnings命令得到。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[官方说明](http://dev.mysql.com/doc/refman/5.5/en/explain-output.html)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### show profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用`show profile`和 `show profiles`我们可以更清楚的了解SQL执行的过程。</span><br><span class="line"></span><br><span class="line">\- 执行过程</span><br><span class="line"></span><br><span class="line">  \1. `set profiling = 1` # 打开profiling</span><br><span class="line"></span><br><span class="line">  \1. 执行查询</span><br><span class="line"></span><br><span class="line">  \1. `show profiles;`</span><br><span class="line"></span><br><span class="line">  \1. 通过`show profile for query N`语句能够看到执行过程中线程的每个状态和消耗的时间。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### performance_schema</span><br><span class="line"></span><br><span class="line">\- 可以代替show profile</span><br><span class="line"></span><br><span class="line">\- 5.5最好不用，性能有问题， 5.6以后建议开启</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### no_sql_cache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">`SQL_NO_CACHE`的真正作用是禁止缓存查询结果，但并不意味着cache不作为结果返回给query。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用方法：`select no_sql_cache ...`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### show full processlist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">可以用语句`SELECT * FROM information_schema.processlist`代替`show full processlist`并可以过虑想要的数据。</span><br><span class="line"></span><br><span class="line">| 字段          | 说明|</span><br><span class="line"></span><br><span class="line">| :------       |:------|</span><br><span class="line"></span><br><span class="line">| id| 不用说了吧，一个标识，你要kill一个语句的时候很有用。|</span><br><span class="line"></span><br><span class="line">| user| 显示单前用户，如果不是root，这个命令就只显示你权限范围内的sql语句。|</span><br><span class="line"></span><br><span class="line">| host| 显示这个语句是从哪个ip的哪个端口上发出的。呵呵，可以用来追踪出问题语句的用户。|</span><br><span class="line"></span><br><span class="line">| db| 显示这个进程目前连接的是哪个数据库。command列，显示当前连接的执行的命令，一般就是休眠（sleep），查询（query），连接（connect）。|</span><br><span class="line"></span><br><span class="line">| time| 此这个状态持续的时间，单位是秒。|</span><br><span class="line"></span><br><span class="line">| state| 显示使用当前连接的sql语句的状态，很重要的列，后续会有所有的状态的描述，请注意，state只是语句执行中的某一个状态，一个sql语句，已查询为例，可能需要经过copying to tmp table，Sorting result，Sending data等状态才可以完成。|</span><br><span class="line"></span><br><span class="line">| info| 显示这个sql语句，因为长度有限，所以长的sql语句就显示不全，但是一个判断问题语句的重要依据。|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### slow_query_log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用`show variables like '%slow%'; `查看是否启用慢查询。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">| 参数          | 说明|</span><br><span class="line"></span><br><span class="line">| :------       |:------|</span><br><span class="line"></span><br><span class="line">|slow_query_log |指定是否开启慢查询日志  |</span><br><span class="line"></span><br><span class="line">|long_query_time |设定慢查询的阀值，超出次设定值的SQL即被记录到慢查询日志，缺省值为10s |</span><br><span class="line"></span><br><span class="line">|slow_query_log_file|指定慢日志文件存放位置，可以为空，系统会给一个缺省的文件host_name-slow.log  |</span><br><span class="line"></span><br><span class="line">|min_examined_row_limit|：查询检查返回少于该参数指定行的SQL不被记录到慢查询日志  |</span><br><span class="line"></span><br><span class="line">|log_queries_not_using_indexes| 不使用索引的慢查询日志是否记录到索引| </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">打开慢查询配置</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>slow_query_log = 1 </p>
<p>slow_query_log_file</p>
<p>long_query_time = 2</p>
<p>log_queries_not_using_indexes</p>
<p>log_slow_queries=/data/3306/slow-log.log</p>
<p>\<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\<span class="comment">##### 慢查询日志分析工具</span></span><br><span class="line"></span><br><span class="line">\- mysqldumpslow</span><br><span class="line"></span><br><span class="line">  \- <span class="string">`mysqldumpslow -s -r -t 10 slow-mysql.log`</span></span><br><span class="line"></span><br><span class="line">​    \- <span class="string">`-s order (c,t,1,r,at,al,ar)`</span> 指定按哪种排序方式输出结果</span><br><span class="line"></span><br><span class="line">​    \- <span class="string">`-t top`</span> 指定取前几条作为结束输出</span><br><span class="line"></span><br><span class="line">\- pt-query-digest</span><br><span class="line"></span><br><span class="line">  \- <span class="string">`pt-query-digest --explain h=127.0.0.1,u=root, p=password slow-mysql.log`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">### 优化数据库（最重要）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">#### 目的</span></span><br><span class="line"></span><br><span class="line">\- 减少数据冗余</span><br><span class="line"></span><br><span class="line">\- 尽量避免数据维护中出现插入、更新、删除异常</span><br><span class="line"></span><br><span class="line">\- 节约数据存储空间</span><br><span class="line"></span><br><span class="line">\- 提高查询效率</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">#### 数据库设计步骤</span></span><br><span class="line"></span><br><span class="line">\- 需求分析：全面了解产品的存储需求</span><br><span class="line"></span><br><span class="line">\- 逻辑设计：设计数据的逻辑存储结构，数据实体之间的逻辑关系，解决数据冗余和数据维护异常</span><br><span class="line"></span><br><span class="line">\- 物理设计：根据数据库特点进行表结构设计（关系型数据库、非关系型数据库、存储引擎）</span><br><span class="line"></span><br><span class="line">\- 维护优化：根据实际情况对索引、存储结构等进行优化</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">#### 范式</span></span><br><span class="line"></span><br><span class="line">遵循三范式就可以设计出符合需求的数据库结构，符合，不是最优的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\- <span class="number">1</span>NF：</span><br><span class="line"></span><br><span class="line">  \- 数据库表中的字段都是单一属性的，不可再分。</span><br><span class="line"></span><br><span class="line">  \- 单一属性的列是由基本的数据类型所构成的</span><br><span class="line"></span><br><span class="line">  \- 设计出来的表都是简单的二维表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\- <span class="number">2</span>NF：首先是 <span class="number">1</span>NF，另外包含两部分内容，一是表必须有一个主键；二是没有包含在主键中的列必须完全依赖于主键，而不能只依赖于主键的一部分。</span><br><span class="line"></span><br><span class="line">\- <span class="number">3</span>NF：首先是 <span class="number">2</span>NF，另外非主键列必须直接依赖于主键，不能存在传递依赖。即不能存在：非主键列 A 依赖于非主键列 B，非主键列 B 依赖于主键的情况。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在设计数据库中要最大程序的遵守三范式，特别是对于OLTP型的系统。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意：三范式最大的问题在于查询时通常需要Join很多表，而这会导致查询效率很低，所以有时候基于性能考虑，我们需要有意违反三范式，适度的做冗余。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">最常见的反范式化的数据的方法是复制或者缓存，在不同的表中存储相同的特定列，使用触发器更新缓存值。</span><br><span class="line"></span><br><span class="line">另一个从父表冗余一些数据到的理由是排序的需要。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">通过触发器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">#### 表设计</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 更小的通常更好，一般情况下，应该尽量使用可以正确存储数据的最小数据类型。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 简单的数据类型，简单数据类型通常需要更好的CPU周期。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 尽量避免使用NULL，通常情况下最好指定列为NOT NULL，除非直接的城崾存储NUL值。注意：把可为NULL的列改为NOT NULL带来的恨不能提升比较小，没有必要首先在现有的schema中查找并修改掉这种情况。但是，如果计划在列上建索引，就应该尽量避免设计成可为NULL的列。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 避免太多的列。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 避免太多的关联，单个查询最好在<span class="number">12</span>个表以内做关联，最多为<span class="number">61</span>个表。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">不在数据库中存储图片、文件等</span><br><span class="line"></span><br><span class="line">所有字段均定义为NOT NULL ，除非你真的想存Null</span><br><span class="line"></span><br><span class="line">字段类型在满足需求条件下越小越好，使用UNSIGNED存储非负整数 ，实际使用时候存储负数场景不多</span><br><span class="line"></span><br><span class="line">使用TIMESTAMP存储时间</span><br><span class="line"></span><br><span class="line">使用varchar存储变长字符串 ，当然要注意varchar(M)里的M指的是字符数不是字节数；使用UNSIGNED INT存储IPv4 地址而不是CHAR(<span class="number">15</span>) ，这种方式只能存储IPv4，存储不了IPv6</span><br><span class="line"></span><br><span class="line">使用DECIMAL存储精确浮点数，用float有的时候会有问题</span><br><span class="line"></span><br><span class="line">少用blob text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">#### 字段类型的选取</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">##### 整数类型</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">| 类型 |</span> 存储空间 <span class="params">| 存储范围 |</span> 存储范围数值 <span class="params">|</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">|</span> <span class="symbol">:------|</span><span class="symbol">:------</span> <span class="params">|:------ |</span><span class="symbol">:------</span> <span class="params">|</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">|</span> TINYINT <span class="params">| 8 |</span> -<span class="number">2</span>&lt;sup&gt;<span class="number">7</span>&lt;<span class="regexp">/sup&gt; ~ 2&lt;sup&gt;7&lt;/sup</span>&gt;-<span class="number">1</span><span class="params">| -128~127 |</span> </span><br><span class="line"></span><br><span class="line"><span class="params">| SMALLINT |</span> <span class="number">16</span> <span class="params">|  -2&lt;sup&gt;15&lt;/sup&gt; ~ 2&lt;sup&gt;15&lt;/sup&gt;-1|</span> -<span class="number">32768</span>~<span class="number">32767</span> <span class="params">|</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">|</span> MEDIUMINT <span class="params">| 24 |</span>  -<span class="number">2</span>&lt;sup&gt;<span class="number">23</span>&lt;<span class="regexp">/sup&gt; ~ 2&lt;sup&gt;23&lt;/sup</span>&gt;-<span class="number">1</span><span class="params">|  -8388608~8388607 |</span></span><br><span class="line"></span><br><span class="line"><span class="params">| INT |</span> <span class="number">32</span> <span class="params">|  -2&lt;sup&gt;31&lt;/sup&gt; ~ 2&lt;sup&gt;31&lt;/sup&gt;-1|</span>  -<span class="number">2147483648</span>~<span class="number">2147483647</span> <span class="params">|</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">|</span> BIGINT <span class="params">| 64 |</span>  -<span class="number">2</span>&lt;sup&gt;<span class="number">63</span>&lt;<span class="regexp">/sup&gt; ~ 2&lt;sup&gt;63&lt;/sup</span>&gt;-<span class="number">1</span><span class="params">|  -9223372036854775808~9223372036854775807 |</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">有符号和无符号使用相同的存储空间，并具有相同的功能，如果不允许负值，大致可以使正数的上限提高一倍。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用整数来存储IPV4，它实际是<span class="number">32</span>位无符号整数，不是字符串，使用小数点将地址发成四段只是为了让人员阅读，通过INET_ATON()和INET_NTOA()函数进行转换。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">##### 实数类型</span></span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 实数是带有小数部分的数字。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. CPU支持直接原生浮点计划，CPU不支持DECIMAL的直接计算，MySQL服务器自身实现了DECIMAL的高精度计算，所以浮点运算明显更快。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. MySQL使用DOUBLE作为内部浮点计算的类型。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确论处时才使用DECIMAL（如存储财务数据），但在数据量比较大的时候，可以考虑使用BIGINT代替DECIMAL，需要存储的货币单位根据小数的倍数乘以相应的倍数即可。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">##### 字符串类型</span></span><br><span class="line"></span><br><span class="line">在INNODB和MYISAM引擎下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 如果长度是明确的，请使用CHAR类型。</span><br><span class="line"></span><br><span class="line">\<span class="number">2</span>. VARCHAR城崾发使用<span class="number">1</span>个或两个额外的字节记录字符串的长度 。</span><br><span class="line"></span><br><span class="line">\<span class="number">3</span>. 给VARCHAR分配真正需要的空间，VARCHAR(<span class="number">5</span>)和VARCHAR(<span class="number">200</span>)存‘hello’的空间开销是一样的，但是更长的列会消耗更多的内存，因为MySQL通常会分配固定大小的内存块来保存内部值。</span><br><span class="line"></span><br><span class="line">\<span class="number">4</span>. 将Text或BLOB类型或超长 的字符类型的字段单独分配到一张表中，只做单表查询。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">##### 日期和时间类型</span></span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. MySQL能存储的最小时间粒度为秒（MariaDB支持微秒级别的时间类型）。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. MySQL提供了两种相似的日期类型：DATETIME和TIMESTAMP，在某些场景下，会有差异。</span><br><span class="line"></span><br><span class="line">\<span class="number">1</span>. 通应该尽量使用TIMESTAMP，比DATETIME空间效率更高。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">| 类型 |</span> 存储空间 <span class="params">|范围 |</span> 精度 <span class="params">| 时区 |</span> 格式化<span class="params">|</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">|</span> <span class="symbol">:------|</span><span class="symbol">:------</span> <span class="params">|:------ |</span><span class="symbol">:------</span> <span class="params">|:------ |</span><span class="symbol">:------</span> <span class="params">|</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">|</span> DATETIME <span class="params">| 8字节 |</span><span class="number">1001</span>~<span class="number">9999</span>年 <span class="params">| 秒|</span> 无关 <span class="params">| YYYYMMDDHHMMSS |</span></span><br><span class="line"></span><br><span class="line"><span class="params">| TIMESTAMP |</span> <span class="number">4</span>字节 <span class="params">|1970-2038年|</span> 秒 <span class="params">| 依赖 |</span> 通过函数转换日期 <span class="params">|</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">\1. 在默认情况下，如果插入时没有指定第一个TIMESTAMP列的值时，MySQL则设置这个列的值为当前时间，在更新一行记录时，MySQL默认也会更新第一个TIMESTAMP列的值。</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">\1. TIMESTAMP列的默认值为NOT NULL。</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">\1. 如果需要存储比秒更小粒度的日期和时间时，可以使用自己的存储格式，可以使用BIGINT类型存储微秒级别的时间戳，或都使用DOUBLE存储秒之后的小数部分。</span></span><br></pre></td></tr></table></figure></p>
<p>last_update timestamp default now() on update now()<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 标识列</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\1. 整数类型通常是标识列最好的选择，可以使用AUTO_INCREMENT。</span><br><span class="line"></span><br><span class="line">\1. 应该尽量避免使用字符串类型使为标识列，很消耗空间，并且比数字型慢，尤其在MYISAM表中，MYISAM默认对字符串使用压缩索引，这会导致查询慢得多（最多有6倍的恨不能下降）。</span><br><span class="line"></span><br><span class="line">\1. 如果存储UUID值，应该移除“-”符号；</span><br><span class="line"></span><br><span class="line">\1. UUID()生成的值有一定的顺序。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 缓存表或中间表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>/<em>重建汇总表或缓存表</em>/</p>
<p>drop table if exists my_summary_new, my_summary_old;</p>
<p>create table my_summary_new like my_summary;</p>
<p>rename table my_sumary to my_summary_old, my_summary_new to my_summary;</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 物化视图(Materialized Views)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">Flexviews</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">\#### 计数器表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在更新时可能出现并发的问题，可以生成多行，每次随机选择一行进行更新。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>create table hit_counter(</p>
<p>​    slot tinyint unsigned not null primary key,</p>
<p>​    cnt int unsigned not null</p>
<p>) engine = innodb;</p>
<p>update hit_counter set cnt = cnt + 1 where slot = rand() * 100;</p>
<p>/<em>每隔一段时间开始一个新的计数器</em>/</p>
<p>create table daily_hit_counter(</p>
<p>​    day date not null,</p>
<p>​    slot tinyint unsigned not null,</p>
<p>​    cnt int unsigned not null,</p>
<p>​    primary key (day, slot)</p>
<p>) engine = innodb;</p>
<p>insert into daily_hit_counter(day, slot, cnt)</p>
<p>values(current_date, rand() *  100 ,1)</p>
<p>on duplicate key update cnt = cnt + 1;</p>
<p>\<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">\---</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\###</span> SQL语句优化</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="string">\-</span> 如何获取有性能问题的SQL</span><br><span class="line"></span><br><span class="line">   <span class="string">\-</span> 通过用户反馈获取存在性能问题的SQL</span><br><span class="line"></span><br><span class="line">   <span class="string">\-</span> 通过是查询日志获取存在性能问题的SQL</span><br><span class="line"></span><br><span class="line">   <span class="string">\-</span> 实时获取存在性能问题的SQL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 查询速度为什么会慢</span><br><span class="line"></span><br><span class="line">  <span class="string">\1.</span> 客户端发送请求给服务器</span><br><span class="line"></span><br><span class="line">  <span class="string">\1.</span> 服务器检查是否可以在查询缓存中命中该SQL</span><br><span class="line"></span><br><span class="line">  <span class="string">\1.</span> 服务器商进行SQL解析，预处理，再由优化器生成对就的执行计划</span><br><span class="line"></span><br><span class="line">  <span class="string">\1.</span> 根据执行计划，调用存储引擎API来查询数据库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> SQL语句的执行顺序</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> FORM: 对FROM的左边的表和右边的表计算笛卡尔积。产生虚表VT1</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> ON: 对虚表VT1进行ON筛选，只有那些符合&lt;join-condition&gt;的行才会被记录在虚表VT2中。</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> JOIN： 如果指定了OUTER JOIN（比如left join、 right join），那么保留表中未匹配的行就会作为外部行添加到虚拟表VT2中，产生虚拟表VT3, rug <span class="keyword">from</span>子句中包含两个以上的表的话，那么就会对上一个join连接产生的结果VT3和下一个表重复执行步骤<span class="number">1</span>~<span class="number">3</span>这三个步骤，一直到处理完所有的表为止。</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> WHERE： 对虚拟表VT3进行WHERE条件过滤。只有符合&lt;where-condition&gt;的记录才会被插入到虚拟表VT4中。</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> GROUP BY: 根据group <span class="keyword">by</span>子句中的列，对VT4中的记录进行分组操作，产生VT5.</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> CUBE | ROLLUP: 对表VT5进行cube或者rollup操作，产生表VT6.</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> HAVING： 对虚拟表VT6应用having过滤，只有符合&lt;having-condition&gt;的记录才会被 插入到虚拟表VT7中。</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> SELECT： 执行select操作，选择指定的列，插入到虚拟表VT8中。</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> DISTINCT： 对VT8中的记录进行去重。产生虚拟表VT9.</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> ORDER BY: 将虚拟表VT9中的记录按照&lt;order_by_list&gt;进行排序操作，产生虚拟表VT10.</span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> LIMIT：取出指定行的记录，产生虚拟表VT11, 并将结果返回。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">优化<span class="keyword">not</span> <span class="keyword">in</span> 和 &lt;&gt; 查询前</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Query语句的优化思路和原则主要提现在以下几个方面：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\1.</span> 优化更需要优化的Query；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\2.</span> 定位优化对象的性能瓶颈；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\3.</span> 明确的优化目标；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\4.</span> 从Explain入手；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\5.</span> 多使用profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\6.</span> 永远用小结果集驱动大的结果集；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\7.</span> 尽可能在索引中完成排序；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\8.</span> 只取出自己需要的Columns；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\9.</span> 仅仅使用最有效的过滤条件；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">10.</span>尽可能避免复杂的Join和子查询；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL 语句调优</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在应用层，通过pt工具和慢查询日志的配合，可以轻松地分辨出全表扫描的语句。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">基本原则</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">避免全表扫描</span><br><span class="line"></span><br><span class="line">建立索引</span><br><span class="line"></span><br><span class="line">尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理</span><br><span class="line"></span><br><span class="line">尽量避免大事务操作，提高系统并发能力</span><br><span class="line"></span><br><span class="line">使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。尽量避免使用游标，因为游标的效率较差。</span><br><span class="line"></span><br><span class="line">雕虫小技</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">关于where 后的条件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">应尽量避免在 where 子句中使用 != 或 &lt;&gt; 操作符，否则将引擎放弃使用索引而进行全表扫描。</span><br><span class="line"></span><br><span class="line">应尽量避免在 where 子句中使用 <span class="keyword">or</span> 来连接条件,可以考虑使用union 代替</span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> 和 <span class="keyword">not</span> <span class="keyword">in</span> 也要慎用，对于连续的数值，能用 between 就不要用 <span class="keyword">in</span>，exists 代替 <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">尽量避免在 where 子句中对字段进行表达式操作和函数操作</span><br><span class="line"></span><br><span class="line">关于数据类型</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。</span><br><span class="line"></span><br><span class="line">尽可能的使用 varchar/nvarchar 代替 char/nchar ，因为变长字段存储空间小，对于查询来说，在一个相对较小的字段内搜索效率显然要高些。</span><br><span class="line"></span><br><span class="line">最好不要给数据库留NULL，尽可能的使用 NOT NULL填充数据库.备注、描述、评论之类的可以设置为 NULL，其他的，最好不要使用NULL。</span><br><span class="line"></span><br><span class="line">任何地方都不要使用 select * <span class="keyword">from</span> t ，用具体的字段列表代替“*”，不要返回用不到的任何字段。</span><br><span class="line"></span><br><span class="line">关于临时表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">避免频繁创建和删除临时表，以减少系统表资源的消耗。对于一次性事件， 最好使用导出表。</span><br><span class="line"></span><br><span class="line">在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。</span><br><span class="line"></span><br><span class="line">如果使用到了临时表，在最后将所有的临时表显式删除时，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。</span><br><span class="line"></span><br><span class="line">关于索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">先应考虑在 where 及 order <span class="keyword">by</span> 涉及的列上建立索引。</span><br><span class="line"></span><br><span class="line">在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件 时才能保证系统使用该索引， 否则该索引将不会 被使用， 并且应尽可能的让字段顺序与索引顺序相一致。</span><br><span class="line"></span><br><span class="line">索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert和update 的效率，因为 insert 或 update 时有可能会重建索引，所以视具体情况而定。一个表的索引数最好不要超过<span class="number">7</span>个，若太多则应考虑一些不常使用到的列上建的索引是否有必要.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\---</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\###</span> 索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 索引是在存储引擎上实现的</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 为什么使用索引?</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 索引大大减少了存储引擎需要扫描的数据量</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 索引可以帮助我们进行排序以避免使用临时表</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 索引可以把随机I/O改为顺序I/O </span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 索引不是越多越好</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 索引会增加写操作的成本</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 太多的索引会增加查询优化器的选择时间</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\####</span> 索引类型</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\#####</span> B-Tree索引</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 特点</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 能够中快数据的查询速度</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 更适合进行范围查找</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 在什么情况下使用</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 全值匹配的查询</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 匹配最左前缀的查询</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 匹配列前缀查询</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 匹配范围值的查询</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 精确匹配左前列并范围匹配别一列</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 只访问索引的查询</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 使用限制</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 如果不是按照索引最左列开始查找，则无法使用索引</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 使用索引时不能跳过索引中的列</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> <span class="keyword">not</span> <span class="keyword">in</span> 和 &lt;&gt; 操作无法使用索引</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 如果查询中有某个列的范围查询，则其所有的列都无法使用索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\#####</span> Hash索引</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 特点</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> Hash索引是基于Hash表实现的，只有查询条件精确匹配Hash索引中的所有列时，才能使用到Hash索引</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 对于Hash索引中的所有列，存储引擎都会为每一行计算一个Hash码，Hash索引中存储的就是Hash码</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 两次查找</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 使用限制</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> Hash索引必须进行二次查找</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> Hash索引无法用于排序</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> Hash索引不支持部分索引查找也不支持范围查找</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\####</span> 建立索引的策略</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 索引列上不能使用表达式或函数</span><br><span class="line"></span><br><span class="line"><span class="string">\</span></span><br></pre></td></tr></table></figure></p>
<p>  /<em>out_date为索引列</em>/</p>
<p>  select …… from product</p>
<p>  where to_days(out_date) - to_days(current_date) &lt; 30</p>
<p>  select …… from product</p>
<p>  where out_date &lt;= date_add(current_date, interval 30 day)</p>
<p>\<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">\-</span> 前缀索引和索引列的选择性</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 索引的选择性是不重复的索引值的表的记录数的比值</span><br><span class="line"></span><br><span class="line"><span class="string">\</span></span><br></pre></td></tr></table></figure></p>
<p>create index index_name on table(col_name(n));</p>
<p>\<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">\-</span> 联合索引</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 如何选择索引列的顺序</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 经常使用到的列优先</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 选择性高的列优先（过滤值多的）</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 宽度小的列优先</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">​    </span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 覆盖索引(直接在索引上获得数据，不读取数据行信息，where、分组、排序)</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 优点</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 可以优化缓存，减少磁盘I/O操作</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 可以减少随机I/O，变随机I/O操作变为顺序操作</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 可以避免对Innodb主键索引的二次查询</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 可以避免MyISAM表进行系统调用</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 无法使用覆盖所引的情况</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 存储引擎不支持覆盖索引</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 查询中使用了太多的列</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 使用了双`%`号的like查询</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\####</span> 使用索引来优化查询</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 使用索引来优化排序</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 通过排序操作</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 按照索引顺序扫描数据</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 索引的列顺序和order <span class="keyword">by</span> 子句的顺序完全一致</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> 索引中所有的列的方向（升序、降序）和order <span class="keyword">by</span> 子句完全一致</span><br><span class="line"></span><br><span class="line">​    <span class="string">\-</span> order <span class="keyword">by</span> 中的字段全部在关联表的中第一张表中</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 模拟Hash索引优化查询</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 增加一个Hash列（md5)</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 只能处理键值的全值匹配查找</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 所使用的Hash函数决定着索引键的大小</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 利用索引优化锁</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 索引可以减少锁定的行数</span><br><span class="line"></span><br><span class="line">  <span class="string">\-</span> 索引可以加快处理速度，同时也加快锁的释放</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\####</span> 索引的维护和优化</span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 删除重复和冗余的索引</span><br><span class="line"></span><br><span class="line"><span class="string">\</span></span><br></pre></td></tr></table></figure></p>
<p>primary ky (id), unique key (id) , index(id)</p>
<p>–联合索引</p>
<p>index(a), index(a,b)</p>
<p>–联合索引</p>
<p>primary key(id), index(a,id)</p>
<p>\<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="string">\-</span> 检查重复和冗余所引 pt-duplicate-key_checker h=<span class="number">127.0</span>.<span class="number">01</span></span><br><span class="line"></span><br><span class="line"><span class="string">\-</span> 查找未被使用过的索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\</span></span><br></pre></td></tr></table></figure></p>
<p>版本《=5.6</p>
<p>查找未被使用的索引：</p>
<p>mysql&gt; select OBJECT_SCHEMA,OBJECT_NAME,INDEX_NAME, b.TABLE_ROWS</p>
<p>from performance_schema.table_io_waits_summary_by_index_usage a</p>
<p>join infomation_schema.tables b on</p>
<p>a.OBJECT_SCHEMA = b.TABLE_SCHEMA and a.OBJECT_NAME = b.TABLE_NAME</p>
<p>where INDEX_NAME is not null  </p>
<p>and COUNT_STAR=0 </p>
<p>and OBJECT_SCHEMA=’xdq’ </p>
<p>and OBJECT_NAME=’order_reasons_dispute’ </p>
<p>order by OBJECT_SCHEMA,OBJECT_NAME;</p>
<p>+—————+———————–+————+</p>
<p>| OBJECT_SCHEMA | OBJECT_NAME           | INDEX_NAME |</p>
<p>+—————+———————–+————+</p>
<p>| xdq           | order_reasons_dispute | PRIMARY    |</p>
<p>| xdq           | order_reasons_dispute | s_uid      |</p>
<p>| xdq           | order_reasons_dispute | b_uid      |</p>
<p>| xdq           | order_reasons_dispute | c_time     |</p>
<p>| xdq           | order_reasons_dispute | r_time     |</p>
<p>+—————+———————–+————+</p>
<p>5 rows in set (0.15 sec)</p>
<p>版本=5.7</p>
<p>mysql&gt; select * from sys.schema_redundant_indexes   冗余索引</p>
<p>mysql&gt; select * from schema_unused_indexes ;      未使用索引  –详见mysql5.7 sys schema视图详解   </p>
<p>mysql&gt; select * from statements_with_full_table_scans; 使用全表扫描的sql语句 等</p>
<p>\<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\- 更新索引统计信息及减少索引碎片</span><br><span class="line"></span><br><span class="line">  \- `annlyze table table_name`</span><br><span class="line"></span><br><span class="line">  \- `optimize table table_name` 会锁表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 规范</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">单个索引字段数不超过<span class="number">5</span>，单表索引数量不超过<span class="number">5</span>，索引设计遵循B+ Tree索引最左前缀匹配原则</span><br><span class="line"></span><br><span class="line">选择区分度高的列作为索引</span><br><span class="line"></span><br><span class="line">建立的索引能覆盖<span class="number">80</span>%主要的查询，不求全，解决问题的主要矛盾</span><br><span class="line"></span><br><span class="line">DML和order by和group by字段要建立合适的索引</span><br><span class="line"></span><br><span class="line">避免索引的隐式转换</span><br><span class="line"></span><br><span class="line">避免冗余索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 原则</span><br><span class="line"></span><br><span class="line">\<span class="number">1.</span> 最左前缀匹配原则，非常重要的原则，MySQL会一直向右匹配直到遇到范围查询(&gt;、&lt;、between、like)就停止匹配，比如a = <span class="number">1</span> and b = <span class="number">2</span> and c &gt; <span class="number">3</span> and d = <span class="number">4</span> 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</span><br><span class="line"></span><br><span class="line">\<span class="number">2.</span> =和in可以乱序，比如a = <span class="number">1</span> and b = <span class="number">2</span> and c = <span class="number">3</span> 建立(a,b,c)索引可以任意顺序，MySQL的查询优化器会帮你优化成索引可以识别的形式</span><br><span class="line"></span><br><span class="line">\<span class="number">3.</span> 尽量选择区分度高的列作为索引,区分度的公式是count(distinct col)/count(*)，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是<span class="number">1</span>，而一些状态、性别字段可能在大数据面前区分度就是<span class="number">0</span>，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是<span class="number">0.1</span>以上，即平均<span class="number">1</span>条扫描<span class="number">10</span>条记录</span><br><span class="line"></span><br><span class="line">\<span class="number">4.</span> 索引列不能参与计算，保持列“干净”，比如from_unixtime(create_time) = ’<span class="number">2014</span><span class="number">-05</span><span class="number">-29</span>’就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成create_time = unix_timestamp(’<span class="number">2014</span><span class="number">-05</span><span class="number">-29</span>’);</span><br><span class="line"></span><br><span class="line">\<span class="number">5.</span> 尽量的扩展索引，不要新建索引。比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 锁机制</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p># 查看当前运行的所有事务</p>
<p>select * from information_schema.innodb_trx;</p>
<p>#查看正在锁的事务</p>
<p>SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS; </p>
<p>#查看等待锁的事务</p>
<p>SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS; </p>
<p>#查询结果为正在被锁状态的表</p>
<p>show OPEN TABLES where In_use &gt; 0;</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 事务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 参数</span><br><span class="line"></span><br><span class="line">\#### innoDB数据库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[参数说明](my-cnf-parameter.md)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">| 内存 | 1G | 2G | 4G | 8G | 16G | 32G | 64G | 72G | 96G | 128G |</span><br><span class="line"></span><br><span class="line">| :------|:------: | :------: |:------:|:------: | :------: |:------:|:------: | :------: |:------:|:------: |</span><br><span class="line"></span><br><span class="line">| innodb_buffer_pool_size | 128M | 768M | 2G | 4G | 10G | 18G |  38G | 48G | 48G | 72G |</span><br><span class="line"></span><br><span class="line">| key_buffer_size | 8M | 16M | 32M | 32M | 64M | 64M | 64M | 64M | 64M | 64M |</span><br><span class="line"></span><br><span class="line">| max_connections | 100 | 500 | 1000 | 2000 | 2000 | 2000 | 2000 | 500 | 5000 | 5000 |</span><br><span class="line"></span><br><span class="line">| max_connect_errors | 100| 100| 100| 100| 100| 100| 100| 100| 100| 100|</span><br><span class="line"></span><br><span class="line">| innodb_file_per_table | 1| 1| 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |</span><br><span class="line"></span><br><span class="line">| innodb_flush_method | O_DIRECT | O_DIRECT | O_DIRECT | O_DIRECT | O_DIRECT | O_DIRECT | O_DIRECT | O_DIRECT | O_DIRECT | O_DIRECT |</span><br><span class="line"></span><br><span class="line">| innodb_log_file_size | 64M | 64M | 128M | 256M | 256M | 512M | 768M | 768M | 768M | 768M |</span><br><span class="line"></span><br><span class="line">| innodb_log_buffer_size | 16M | 32M | 64M | 128M | 128M | 128M | 128M | 256M | 256M | 256M |</span><br><span class="line"></span><br><span class="line">| innodb_flush_log_at_trx_commit | 2 | 2 | 2 | 2 | 2 | 2 | 2 | 2 | 2 | 2 |</span><br><span class="line"></span><br><span class="line">| innodb_doublewrite | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |</span><br><span class="line"></span><br><span class="line">| query_cache_size | 32M | 32M | 32M | 32M | 32M | 32M | 64M | 64M | 128M | 128M |</span><br><span class="line"></span><br><span class="line">| log_bin | MySQL-bin| MySQL-bin| MySQL-bin| MySQL-bin| MySQL-bin| MySQL-bin| MySQL-bin| MySQL-bin| MySQL-bin| MySQL-bin|</span><br><span class="line"></span><br><span class="line">| skip_name_resolve | 开启 | 开启| 开启| 开启| 开启| 开启| 开启| 开启| 开启| 开启|</span><br><span class="line"></span><br><span class="line">| table_open_cache | | | | | | | | | | |</span><br><span class="line"></span><br><span class="line">| max_allowed_packet | 32M | 32M | 32M | 32M | 32M | 32M | 32M | 32M | 32M | 32M |</span><br><span class="line"></span><br><span class="line">| innodb_lock_wait_timeout | 60| 60| 60| 60| 60| 60| 60| 60| 60|60|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 可选参数</span><br><span class="line"></span><br><span class="line">| 内存 | 1G | 2G | 4G | 8G | 16G | 32G | 64G | 72G | 96G | 128G |</span><br><span class="line"></span><br><span class="line">| :------|:------: | :------: |:------:|:------: | :------: |:------:|:------: | :------: |:------:|:------: |</span><br><span class="line"></span><br><span class="line">| thread_stack | 256K | 256K | 256K | 256K | 256K | 256K | 512K | 512K |512K | 512K |</span><br><span class="line"></span><br><span class="line">| sort_buffer_size | 256K | 256K | 512K | 512K | 1M | 1M | 2M | 2M |2M | 2M |</span><br><span class="line"></span><br><span class="line">| read_buffer_size | 256K | 256K | 512K | 512K | 1M | 1M | 2M | 2M | 2M |2M |</span><br><span class="line"></span><br><span class="line">| read_rnd_buffer_size | 256K | 512K | 512K | 1M | 1M | 2M | 2M | 2M | 2M | 2M |</span><br><span class="line"></span><br><span class="line">| join_buffer_size | 256K |256K | 512K | 512K | 1M | 1M | 2M | 2M | 2M | 2M |</span><br><span class="line"></span><br><span class="line">| binlog_cache_size | 64K | 64K | 64K | 64K | 64K | 64K | 128K | 128K |128K | 128K |</span><br><span class="line"></span><br><span class="line">| max_binlog_size | 256M| 256M| 256M| 256M| 256M| 256M| 256M| 256M| 256M| 256M|</span><br><span class="line"></span><br><span class="line">| max_heap_table_size | 64M| 128M| 1G| 1G| 1G| 1G| 1G| 1G| 2G| 2G|</span><br><span class="line"></span><br><span class="line">| bulk_insert_buffer_size| 64M| 128M| 1G| 1G| 1G| 1G| 1G| 1G| 2G| 2G|</span><br><span class="line"></span><br><span class="line">| tmp_table_size | 64M| 128M| 1G| 1G| 1G| 1G| 1G| 1G| 2G| 2G|</span><br><span class="line"></span><br><span class="line"><span class="attribute">sysdate_is_now</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">\#### 内存参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\- 确定可以可用的内存的上限</span><br><span class="line"></span><br><span class="line">\- 确定MYSQL的每个连接使用的内存</span><br><span class="line"></span><br><span class="line">\- 每个线程所需要的内存有</span><br><span class="line"></span><br><span class="line">​	*  sort_buffer_size</span><br><span class="line"></span><br><span class="line">​	*  read_buffer_size</span><br><span class="line"></span><br><span class="line">​	*  read_rnd_buffer_size</span><br><span class="line"></span><br><span class="line">​	*  join_buffer_size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">innodb_buffer_pool_size = 总内存 - (每个线程所需要的内存*连接数) -系统保留内存</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key_buffer_size = select sum(index_lengh) from information_schema.tables where engine='myisam'</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### IO参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\- innodb </span><br><span class="line"></span><br><span class="line">​	* innodb_log_file_size</span><br><span class="line"></span><br><span class="line">​	* innodb_log_files_in_group</span><br><span class="line"></span><br><span class="line">​	* 事务日志总大小 = innodb_log_file_size * innodb_log_files_in_group</span><br><span class="line"></span><br><span class="line">​	* innodb_log_buffer_size</span><br><span class="line"></span><br><span class="line">​	* innodb_flush_log_at_trx_commit</span><br><span class="line"></span><br><span class="line">​	* innodb_flush_method</span><br><span class="line"></span><br><span class="line">​	* innodb_file_per_table</span><br><span class="line"></span><br><span class="line">​	* innodb_doublewrite(对性能有影响，但不大，建议开启)</span><br><span class="line"></span><br><span class="line">\- MYISAM</span><br><span class="line"></span><br><span class="line">​	* delay_key_write</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 安全参数	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\- expire_logs_days 指定自动清理binlog的天数(兼容两次全备份的天数)</span><br><span class="line"></span><br><span class="line">\- max_allowed_packet 控制MySQL可以接收的包的大小</span><br><span class="line"></span><br><span class="line">\- skip_name_resolve 禁用DNS查找</span><br><span class="line"></span><br><span class="line">\- sysdate_is_now 确保sysdate()返回确定性天数</span><br><span class="line"></span><br><span class="line">\- read_only 禁止非super权限的用户写权限（主从在备库中用）</span><br><span class="line"></span><br><span class="line">\- skip_salve_start 禁用Slave自动恢复</span><br><span class="line"></span><br><span class="line">\- sql_mode 设备MySQL所使用的SQL模式（不要轻易改动生产环境下的sql_mode值）</span><br><span class="line"></span><br><span class="line">​	* strict_trans_tables</span><br><span class="line"></span><br><span class="line">​	* no_engine_subtitution</span><br><span class="line"></span><br><span class="line">​	* no_zero_date</span><br><span class="line"></span><br><span class="line">​	* no_zero_in_date</span><br><span class="line"></span><br><span class="line">​	* only_full_group_by</span><br><span class="line"></span><br><span class="line">​	* 其他...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 其他参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\- sync_binlog 控制MySQL如何向磁盘刷新binlog(主库中建议写成1)</span><br><span class="line"></span><br><span class="line">\- tmp_table_size 和 max_heap_table_size(一起使用) 控制内存临时表大小，值设置成一样</span><br><span class="line"></span><br><span class="line">\- max_connections 最大连接数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 操作系统和硬件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 应用系统</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 复制</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 架构</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 可扩展</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#### 高可用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 备份与恢复</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### mysql 监控</span><br><span class="line"></span><br><span class="line">\- 可用性监控</span><br><span class="line"></span><br><span class="line">  \- 确认网络连接</span><br><span class="line"></span><br><span class="line">​    \- mysqladmin -u(user)-p -h（ip） ping</span><br><span class="line"></span><br><span class="line">​    \- telnet ip db_port</span><br><span class="line"></span><br><span class="line">​    \- 使用程序通过网络建立数据库连接</span><br><span class="line"></span><br><span class="line">  \- 数据库是否可读写</span><br><span class="line"></span><br><span class="line">​    \- 检查数据库的read_only参数是否为off</span><br><span class="line"></span><br><span class="line">​    \- 建立监控表并对表中数据进行读写操作</span><br><span class="line"></span><br><span class="line">​    \- 执行简单的查询 select @@version</span><br><span class="line"></span><br><span class="line">  \- 监控数据库的连接数</span><br><span class="line"></span><br><span class="line">​    \- show variables like 'max_connections';</span><br><span class="line"></span><br><span class="line">​    \- show global status like 'Threads_connected';</span><br><span class="line"></span><br><span class="line">​    \- Threads_connected / max_connections &gt;  0.8</span><br><span class="line"></span><br><span class="line">\- 性能监控</span><br><span class="line"></span><br><span class="line">  \- 记录性能监控过程中所采集到的数据库状态</span><br><span class="line"></span><br><span class="line">  \- 如何计算QPS和TPS</span><br><span class="line"></span><br><span class="line">​     \- show grobal status like 'queries' 和 show global status like 'uptime_since_flush_status'</span><br><span class="line"></span><br><span class="line">​     \- QPS = (queries2 - queries1) / (uptime_since_flush_status2 - uptime_since_flush_status1)</span><br><span class="line"></span><br><span class="line">​     \- TPS = ((Com_insert2 + Com_update2 + Com_delete2) - (Com_insert1 + Com_update1 + Com_delete1) ) / (Update_since_flush_status2 - Uptime_since_flush_status1)</span><br><span class="line"></span><br><span class="line">  \- 如何监控数据库并发请求数据</span><br><span class="line"></span><br><span class="line">​    \- show global like 'Thread_running'   </span><br><span class="line"></span><br><span class="line">​    \- 数据库系统的性能会随着并发处理请求数据的增加而下降</span><br><span class="line"></span><br><span class="line">​    \- 并发处理的数据量通常会远小于同一时间连接到数据库的纯种的数量</span><br><span class="line"></span><br><span class="line">  \- 如何监控Innodb的阻塞</span><br><span class="line"></span><br><span class="line">​    \- 通过语句来查询（参考下面的语）</span><br><span class="line"></span><br><span class="line">\- 主从复制监控</span><br><span class="line"></span><br><span class="line">  \- 主从复制的链路状态</span><br><span class="line"></span><br><span class="line">​    \- Slave_IO_Running: Yes(出现非Yes就报警)</span><br><span class="line"></span><br><span class="line">​    \- Slave_SQL_Running: Yes(出现非Yes就报警)</span><br><span class="line"></span><br><span class="line">  \- 主从复制延迟</span><br><span class="line"></span><br><span class="line">​    \- Seconds_behind_Master</span><br><span class="line"></span><br><span class="line">​    \- show master status \G</span><br><span class="line"></span><br><span class="line">​    \- show slave status \G</span><br><span class="line"></span><br><span class="line">​    \- 比较偏移量</span><br><span class="line"></span><br><span class="line">  \- 主从复制一致性</span><br><span class="line"></span><br><span class="line">​    \- pt-table-checksum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 工具</span><br><span class="line"></span><br><span class="line">  \- oneproxy 分表分库 </span><br><span class="line"></span><br><span class="line">  \- mycat</span><br><span class="line"></span><br><span class="line">  \- maxscale</span><br><span class="line"></span><br><span class="line">  \- pt-duplicate-key-checker #删除重复和冗余的索引</span><br><span class="line"></span><br><span class="line">  \- pt-query-digest #慢查询日志分析工具</span><br><span class="line"></span><br><span class="line">  \- mysqlbinlog #日志查看工具</span><br><span class="line"></span><br><span class="line">  \- pt-table-checksum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\### 数据库性能优化常用sql脚本总结</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\1. 当前连接的Session 有多少</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>SELECT login_name</p>
<p>​    ,[program_name]</p>
<p>​    ,COUNT(session_id) AS [session_count]</p>
<p>FROM sys.dm_exec_sessions WITH (NOLOCK)</p>
<p>GROUP BY login_name,[program_name]</p>
<p>ORDER BY COUNT(session_id) desc;</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\2. 每个数据库上的Session 数量是多少</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>SELECT DB_NAME(dbid) AS DBName</p>
<p>​    ,COUNT(dbid) AS NumberOfConnections</p>
<p>​    ,loginame AS LoginName</p>
<p>FROM sys.sysprocesses</p>
<p>WHERE dbid &gt; 0 </p>
<p>GROUP BY dbid,loginame</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\3. 查看阻塞</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>SELECT</p>
<p>​    SPID                = er.session_id</p>
<p>​    ,STATUS             = ses.STATUS</p>
<p>​    ,[LOGIN]            = ses.login_name</p>
<p>​    ,HOST               = ses.host_name</p>
<p>​    ,BlkBy              = er.blocking_session_id</p>
<p>​    ,DBName             = DB_NAME(er.database_id)</p>
<p>​    ,CommandType        = er.command</p>
<p>​    ,SQLStatement       = st.text</p>
<p>​    ,BlockingText     = bst.text</p>
<p>​    ,ObjectName         = OBJECT_NAME(st.objectid)</p>
<p>​    ,ElapsedMS          = er.total_elapsed_time</p>
<p>​    ,CPUTime            = er.cpu_time</p>
<p>​    ,IOReads            = er.logical_reads + er.reads</p>
<p>​    ,IOWrites           = er.writes</p>
<p>​    ,LastWaitType       = er.last_wait_type</p>
<p>​    ,StartTime          = er.start_time</p>
<p>​    ,Protocol           = con.net_transport</p>
<p>​    ,ConnectionWrites   = con.num_writes</p>
<p>​    ,ConnectionReads    = con.num_reads</p>
<p>​    ,ClientAddress      = con.client_net_address</p>
<p>​    ,Authentication     = con.auth_scheme</p>
<p>FROM sys.dm_exec_requests er</p>
<p>OUTER APPLY sys.dm_exec_sql_text(er.sql_handle) st</p>
<p>LEFT JOIN sys.dm_exec_sessions ses</p>
<p>ON ses.session_id = er.session_id</p>
<p>LEFT JOIN sys.dm_exec_connections con</p>
<p>ON con.session_id = ses.session_id</p>
<p>LEFT JOIN sys.dm_exec_requests ber</p>
<p>ON er.blocking_session_id=ber.session_id</p>
<p>OUTER APPLY sys.dm_exec_sql_text(ber.sql_handle) bst</p>
<p>WHERE er.session_id &gt; 50</p>
<p>ORDER BY er.blocking_session_id DESC,er.session_id</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">\4. 找出哪些表的Index 需要改进</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>SELECT CONVERT(DECIMAL(18, 2), user_seeks <em> avg_total_user_cost </em> (avg_user_impact * 0.01)) AS [index_advantage]</p>
<p>​    ,migs.last_user_seek</p>
<p>​    ,mid.[statement] AS [Database.Schema.Table]</p>
<p>​    ,mid.equality_columns</p>
<p>​    ,mid.inequality_columns</p>
<p>​    ,mid.included_columns</p>
<p>​    ,migs.unique_compiles</p>
<p>​    ,migs.user_seeks</p>
<p>​    ,migs.avg_total_user_cost</p>
<p>​    ,migs.avg_user_impact</p>
<p>FROM sys.dm_db_missing_index_group_stats AS migs WITH (NOLOCK)</p>
<p>INNER JOIN sys.dm_db_missing_index_groups AS mig WITH (NOLOCK) ON migs.group_handle = mig.index_group_handle</p>
<p>INNER JOIN sys.dm_db_missing_index_details AS mid WITH (NOLOCK) ON mig.index_handle = mid.index_handle</p>
<p>ORDER BY index_advantage desc</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> select object_schema, object_name, i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\5. 查看Index 的Statistics 最后更新时间</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>SELECT SCHEMA_NAME(o.[schema_id]) + N’.’ + o.[name] AS [Object Name]</p>
<p>​    ,o.type_desc AS [Object Type]</p>
<p>​    ,i.[name] AS [Index Name]</p>
<p>​    ,STATS_DATE(i.[object_id], i.index_id) AS [Statistics Date]</p>
<p>​    ,s.auto_created</p>
<p>​    ,s.no_recompute</p>
<p>​    ,s.user_created</p>
<p>​    ,st.row_count</p>
<p>​    ,st.used_page_count</p>
<p>FROM sys.objects AS o WITH (NOLOCK)</p>
<p>INNER JOIN sys.indexes AS i WITH (NOLOCK) ON o.[object_id] = i.[object_id]INNER JOIN sys.stats AS s WITH (NOLOCK) ON i.[object_id] = s.[object_id]</p>
<p>​    AND i.index_id = s.stats_id</p>
<p>INNER JOIN sys.dm_db_partition_stats AS st WITH (NOLOCK) ON o.[object_id] = st.[object_id]</p>
<p>​    AND i.[index_id] = st.[index_id]WHERE o.[type] IN (‘U’,’V’)</p>
<p>​    AND st.row_count &gt; 0</p>
<p>ORDER BY STATS_DATE(i.[object_id], i.index_id) desc;</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">\6. 查看Index 碎片化指数</span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>SELECT DB_NAME(ps.database_id) AS [Database Name]</p>
<p>​    ,OBJECT_NAME(ps.[object_id]) AS [Object Name]</p>
<p>​    ,i.[name] AS [Index Name]</p>
<p>​    ,ps.index_id</p>
<p>​    ,ps.index_type_desc</p>
<p>​    ,ps.avg_fragmentation_in_percent</p>
<p>​    ,ps.fragment_count</p>
<p>​    ,ps.page_count</p>
<p>​    ,i.fill_factor</p>
<p>​    ,i.has_filter</p>
<p>​    ,i.filter_definition</p>
<p>FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, N’LIMITED’) AS ps</p>
<p>INNER JOIN sys.indexes AS i WITH (NOLOCK) ON ps.[object_id] = i.[object_id]</p>
<p>​    AND ps.index_id = i.index_id</p>
<p>WHERE ps.database_id = DB_ID()</p>
<p>​    AND ps.page_count &gt; 2500</p>
<p>ORDER BY ps.avg_fragmentation_in_percent desc;</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">\7. 查询前 10 个可能是性能最差的 SQL 语句</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>SELECT TOP 10 TEXT AS ‘SQL Statement’</p>
<p>​    ,last_execution_time AS ‘Last Execution Time’</p>
<p>​    ,(total_logical_reads + total_physical_reads + total_logical_writes) / execution_count AS [Average IO]</p>
<p>​    ,(total_worker_time / execution_count) / 1000000.0 AS [Average CPU Time (sec)]</p>
<p>​    ,(total_elapsed_time / execution_count) / 1000000.0 AS [Average Elapsed Time (sec)]</p>
<p>​    ,execution_count AS “Execution Count”</p>
<p>​    ,qp.query_plan AS “Query Plan”</p>
<p>FROM sys.dm_exec_query_stats qs</p>
<p>CROSS APPLY sys.dm_exec_sql_text(qs.plan_handle) st</p>
<p>CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp</p>
<p>ORDER BY total_elapsed_time / execution_count DESC</p>
<p>\<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\8. 查询Innode阻塞</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\</span><br></pre></td></tr></table></figure></p>
<p>select b.trx_mysql_thread_id as 被阻塞线程</p>
<p>,b.trx_query as 被阻塞SQL</p>
<p>,c.trx_mysql_thread_id as 阻塞线程</p>
<p>,c.trx_query as 阻塞SQL</p>
<p>,(UNIX_TIMESTAMP() - UNIX_TIMESTAMP(c.trx_started)) as 阻塞时间 </p>
<p>from</p>
<p>information_schema.innodb_lock_waits a </p>
<p>join</p>
<p>information_schema.innodb_trx b</p>
<p>on a.requesting_trx_id=b.trx_id </p>
<p>join</p>
<p>information_schema.innodb_trx c</p>
<p>on a.blocking_trx_id=c.trx_id </p>
<p>where</p>
<p>(UNIX_TIMESTAMP() - UNIX_TIMESTAMP(c.trx_started))&gt; 10</p>
<p>`<code></code></p>
<p>### 参考</p>
<p>- <a href="https://segmentfault.com/a/1190000004946420#articleHeader2" target="_blank" rel="noopener">https://segmentfault.com/a/1190000004946420#articleHeader2</a></p>
<p>- <a href="http://www.cnblogs.com/rollenholt/p/3776923.html" target="_blank" rel="noopener">http://www.cnblogs.com/rollenholt/p/3776923.html</a></p>
<p>- 《打造扛得住的MySQL数据库架构》</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/09/30/mysql/">mysql优化</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 代晓炜 的个人博客">代晓炜</a></p>
        <p><span>发布时间:</span>2018年09月30日 - 13时40分</p>
        <p><span>最后更新:</span>2018年11月05日 - 13时46分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/09/30/mysql/" title="mysql优化">http://yoursite.com/2018/09/30/mysql/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2018/09/30/mysql/　　作者: 代晓炜" title=""></span>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target="_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2018/10/05/IDEA/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          IDEA快捷键
        
      </div>
    </a>
  
  
    <a href="/2018/09/09/cordova/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">cordova 命令</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL优化步（InnoDB）"><span class="toc-number">1.</span> <span class="toc-text">MySQL优化步（InnoDB）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#优化的优先级"><span class="toc-number">1.1.</span> <span class="toc-text">优化的优先级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#图书"><span class="toc-number">1.2.</span> <span class="toc-text">图书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装向导中的选项"><span class="toc-number">1.3.</span> <span class="toc-text">安装向导中的选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调试方法"><span class="toc-number">1.4.</span> <span class="toc-text">调试方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#show-status"><span class="toc-number">1.4.1.</span> <span class="toc-text">show status</span></a></li></ol></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>
<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";
    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>




<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
        <section class="changyan" id="comments">
  <!--<div id="uyan_frame"></div>-->
  <div id="SOHUCS"></div>
  <script charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/changyan.js"></script>
  <script type="text/javascript">
    window.changyan.api.config({
      appid: 'xxxx',
      conf: 'xxxxxxxxx'
    });
  </script>
</section>
    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/10/05/IDEA/" title="上一篇: IDEA快捷键">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2018/09/09/cordova/" title="下一篇: cordova 命令">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/26/jvm-gc/">jvm gc</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/26/jvm/">jvm</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/19/mysql2/">mysql基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/python2/">python 基础 2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/python1/">python 基础之数据类型和变量</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/05/markdown/">markdown语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/31/javaIo/">java Io</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/05/IDEA/">IDEA快捷键</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/30/mysql/">mysql优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/09/cordova/">cordova 命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/03/vue/">VUE 基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/28/linux/">linux</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/16/http/">http状态码</a></li></ul>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

    <script>
        $(".post-list").addClass("toc-article");
        // $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2018 代晓炜
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo &nbsp;&nbsp;</a><a href="https://github.com/maochunguang" target="_blank">Blog</a> by tommy
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit">极客到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'xxxxx', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?xxxxxx";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>



<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(
            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>